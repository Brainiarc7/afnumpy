cache:
  paths:
    - $HOME/.cache/pip
    - $HOME/arrayfire
    - $HOME/arrayfire-python
    - $HOME/local

stages:
  - prepare
  - build
  - test

prepare_job:
  tags:
    - cuda
  stage: prepare
  script:
    - cd $HOME
    - if [ ! -d "$HOME/arrayfire/.git" ]; then git clone  https://github.com/arrayfire/arrayfire; else echo 'Using arrayfire from cached directory'; fi
    - mkdir -p arrayfire/build && cd arrayfire/build
    - git pull
    - cmake -DCMAKE_CXX_COMPILER=/usr/bin/g++ -DBUILD_CPU=OFF -DBUILD_CUDA=ON -DBUILD_OPENCL=OFF -DBUILD_GRAPHICS=OFF -DBUILD_TEST=OFF -DBUILD_EXAMPLES=OFF  -DCMAKE_INSTALL_PREFIX=${HOME}/local .. 
    - make -j 2
    - make install
    - export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:${HOME}/local/lib
    # Install arrayfire-python
    - cd $HOME
    - if [ ! -d "$HOME/arrayfire-python/.git" ]; then git clone  https://github.com/arrayfire/arrayfire-python.git; else echo 'Using arrayfire-python from cached directory'; fi
    - cd arrayfire-python
    - git pull
    - python setup.py install  
  
build_job:
  tags:
    - cuda
  stage: build
  script:
    - cd ${HOME}/build/FilipeMaia/afnumpy
    - python setup.py install

test_job:
  tags: 
    - cuda
  stage: test
  script:
    - cd ${HOME}/build/FilipeMaia/afnumpy
    - coverage run --source afnumpy -m py.test  -v --color=yes --showlocals --durations=10
    - codecov
